<!--
Name: main.html
Authors: Jack Morice, Nick Grieco, Alex Carrillo, Gunther Luechtefield
Description: This file contains the HTML template for the main page of the Enclav3 application. 
It defines the structure and layout of the page, including the display of password entries and the form for adding new entries. 
The template uses Jinja2 syntax to dynamically render password entries from the database and to display flash messages for user feedback.
Inputs: Password entries retrieved from the database, flash messages for user feedback
Outputs: Rendered HTML page displaying password entries and a form for adding new entries
-->
<!DOCTYPE html>

<link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">


<body>
    <div class="grid">
        <div class="register">
            <div class="brand">Enclav3</div>
            <div class="subtitle">Your passwords</div>

            {% with messages = get_flashed_messages() %}
              {% if messages %}
                {% for message in messages %}
                  <div class="success">{{ message }}</div>
                {% endfor %}
              {% endif %}
            {% endwith %}

            {% if tier1_entries or tier2_entries or tier3_entries %} <!-- only show tiers if there are entries -->

            <div class="tier_groups">

                <!-- TIER 1 -->
                <details class="tier_group" open>
                    <summary class="tier_summary">
                        <span>Tier 1</span>
                        <span class="tier_count">({{ tier1_entries|length }})</span>
                    </summary>

                    <div class="password_cards"> 
                        {% for entry in tier1_entries %}
                        <div class="password_card">

                            <div class="card_header">
                                <h3>{{ entry.site }}</h3>

                                <div class="card_actions"> <!-- displays the date the entry was created and a delete button -->
                                    <span class="card_date">{{ entry.created_at }}</span>

                                    <form class="delete_form" 
                                        method="POST"
                                        action="{{ url_for('delete_entry', entry_id=entry.id) }}">
                                        <button type="submit"
                                                class="delete_button"
                                                title="Delete"
                                                onclick="return confirm('Delete this entry?')">
                                            üóëÔ∏è
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div class="card_body">

                                <p class="field_row"> <!-- displays the username with a copy button -->
                                    <strong>Username:</strong>
                                    <span class="field_value">{{ entry.username }}</span>
                                    <button type="button"
                                            class="copy_button"
                                            data-copy="{{ entry.username }}">
                                        Copy
                                    </button>
                                </p>

                                <p class="field_row"> <!-- displays the password with a button to show and hide and a copy button -->
                                    <strong>Password:</strong>
                                    <span class="password_text">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                                    <span class="real_password" style="display:none;">
                                        {{ entry.password }}
                                    </span>

                                    <button type="button" class="toggle_password">Show</button>
                                    <button type="button"
                                            class="copy_button"
                                            data-copy="{{ entry.password }}">
                                        Copy
                                    </button>
                                </p>

                                {% if entry.notes %}
                                <p>
                                    <strong>Notes:</strong> {{ entry.notes }}
                                </p>
                                {% endif %}

                            </div>
                        </div>

                        {% else %}
                        <p class="empty_tier">No Tier 1 passwords yet.</p>
                        {% endfor %}
                    </div>
                </details>

                <!-- TIER 2 -->
                <details class="tier_group">
                    <summary class="tier_summary">
                        <span>Tier 2</span>
                        <span class="tier_count">({{ tier2_entries|length }})</span>
                    </summary>

                    <div class="password_cards">
                        {% for entry in tier2_entries %}
                        <div class="password_card">

                            <div class="card_header">
                                <h3>{{ entry.site }}</h3>

                                <div class="card_actions">
                                    <span class="card_date">{{ entry.created_at }}</span>

                                    <form class="delete_form"
                                        method="POST"
                                        action="{{ url_for('delete_entry', entry_id=entry.id) }}">
                                        <button type="submit"
                                                class="delete_button"
                                                title="Delete"
                                                onclick="return confirm('Delete this entry?')">
                                            üóëÔ∏è
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div class="card_body">

                                <p class="field_row">
                                    <strong>Username:</strong>
                                    <span class="field_value">{{ entry.username }}</span>
                                    <button type="button"
                                            class="copy_button"
                                            data-copy="{{ entry.username }}">
                                        Copy
                                    </button>
                                </p>

                                <p class="field_row">
                                    <strong>Password:</strong>
                                    <span class="password_text">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                                    <span class="real_password" style="display:none;">
                                        {{ entry.password }}
                                    </span>

                                    <button type="button" class="toggle_password">Show</button>
                                    <button type="button"
                                            class="copy_button"
                                            data-copy="{{ entry.password }}">
                                        Copy
                                    </button>
                                </p>

                                {% if entry.notes %}
                                <p>
                                    <strong>Notes:</strong> {{ entry.notes }}
                                </p>
                                {% endif %}

                            </div>
                        </div>

                        {% else %}
                        <p class="empty_tier">No Tier 2 passwords yet.</p>
                        {% endfor %}
                    </div>
                </details>

                <!-- TIER 3 -->
                <details class="tier_group">
                    <summary class="tier_summary">
                        <span>Tier 3</span>
                        <span class="tier_count">({{ tier3_entries|length }})</span>
                    </summary>

                    <div class="password_cards">
                        {% for entry in tier3_entries %}
                        <div class="password_card">

                            <div class="card_header">
                                <h3>{{ entry.site }}</h3>

                                <div class="card_actions">
                                    <span class="card_date">{{ entry.created_at }}</span>

                                    <form class="delete_form"
                                        method="POST"
                                        action="{{ url_for('delete_entry', entry_id=entry.id) }}">
                                        <button type="submit"
                                                class="delete_button"
                                                title="Delete"
                                                onclick="return confirm('Delete this entry?')">
                                            üóëÔ∏è
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div class="card_body">
                                <p class="field_row">
                                    <strong>Username:</strong>
                                    <span class="field_value">{{ entry.username }}</span>
                                    <button type="button"
                                            class="copy_button"
                                            data-copy="{{ entry.username }}">
                                        Copy
                                    </button>
                                </p>

                                <p class="field_row">
                                    <strong>Password:</strong>
                                    <span class="password_text">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                                    <span class="real_password" style="display:none;">{{ entry.password }}</span>

                                    <button type="button" class="toggle_password">Show</button>
                                    <button type="button"
                                            class="copy_button"
                                            data-copy="{{ entry.password }}">
                                        Copy
                                    </button>
                                </p>

                                {% if entry.notes %}
                                <p><strong>Notes:</strong> {{ entry.notes }}</p>
                                {% endif %}
                            </div>

                        </div>
                        {% else %}
                        <p class="empty_tier">No Tier 3 passwords yet.</p>
                        {% endfor %}
                    </div>
                </details>

            </div> <!-- end tier_groups -->
            
            {% else %}
            <div class="subtitle">No passwords yet. Add your first one below.</div>
            {% endif %}

            <form class="form" method="POST" action="/add-entry">
                            
                <div class="form_layout">
                    <!-- left side of box -->
                    <div class="form_left">
                        <div class="title">Add a Password</div>
                        <div class="form__field" >
                            <input type="text" name="site" autocomplete="off" autocapitalize="on" placeholder="Site" required />
                        </div>
                        <div class="form__field" >
                            <input type="text" name="username" autocomplete="off" placeholder="Username" required />
                        </div>
                        <div class="form__field" >
                            <input type="password" name="password" autocomplete="off" placeholder="Password" required />
                        </div>
                        
                        <div class="form__field" >
                            <input type="text" name="notes" autocomplete="off" placeholder="Notes (optional)" />
                        </div>
                    </div>

                    <!-- right side of box -->
                    <div class="form_right"> 
                        <div class="title">Choose a Password Tier</div>

                        <div class="radio_option">
                            <input type="radio" id="tier1" name="option" value="low" checked> 
                            <label for ="tier1">Tier 1</label>
                        </div>
                        <div class="radio_option">
                            <input type="radio" id="tier2" name="option" value="medium"> 
                            <label for ="tier2">Tier 2</label>
                        </div>
                        <div class="radio_option">
                            <input type="radio" id="tier3" name="option" value="high"> 
                            <label for ="tier3">Tier 3</label>
                        </div>
                    </div>      
                </div>
                <div class="form__field">
                    <input type="submit" value="Add Password" />
                </div>
            </form>

            <a href="/logout" class="logout">Logout</a>
            <a href="/settings" class="settings">Settings</a>
        </div>
    </div>

<script>
document.querySelectorAll(".toggle_password").forEach(button => {
    button.addEventListener("click", function() {
        const card = this.closest(".card_body");
        const hidden = card.querySelector(".password_text");
        const real = card.querySelector(".real_password");

        if (real.style.display === "none") {
            real.style.display = "inline";
            hidden.style.display = "none";
            this.textContent = "Hide";
        } else {
            real.style.display = "none";
            hidden.style.display = "inline";
            this.textContent = "Show";
        }
    });
});

// Listens for clicks on the page
document.addEventListener("click", async (e) => {

// checks if the clicked button is a button with the class copy button
  const btn = e.target.closest(".copy_button");
  if (!btn) return;

  const text = btn.dataset.copy;

  try {
    // copies the text 
    await navigator.clipboard.writeText(text);

    const original = btn.textContent;
    btn.textContent = "Copied!";

    // displays the message copied for 2 seconds
    setTimeout(() => btn.textContent = original, 2000);

  } catch {
    // if copying fails
    btn.textContent = "Failed";
  }
});

</script>
</body>


</html>